---
title: "NFL Point Spread: 1978-2013"
format: html
editor: source
execute: 
  echo: false
  warning: false
  message: false
---

NFL (National Football League) point spread is a major focus point for those looking to place wagers on upcoming weekly games during the football season.

The point spread is a figure generated by an oddsmaker to equalize wagering between opponents, which in the NFL is a matchup between two teams -- a favorite and an underdog. In the instance when a matchup does not have either a favorite or an underdog, the point spread is set at 0 and the game is designated as a "Pick'em."

An example of a point spread in play is the [September 5th, 2013 matchup between the Denver Broncos and the Baltimore Ravens](https://www.pro-football-reference.com/boxscores/201309050den.htm), where the point spread was 7.5 points. The Denver Broncos were favored by 7.5 points and would go on to outscore the Baltimore Ravens 49 to 27. For wagers on the favored Denver Broncos, the score was adjusted to reflect 49 minus 7.5 for a final score of 41.5 for the Denver Broncos versus 27 for the Baltimore Ravens. For wagers on the underdog Baltimore Ravens, the score was adjusted to reflect 27 plus 7.5 for a final score of 34.5 for the Baltimore Ravens versus 49 for the Denver Broncos.

The data downloaded from [Kaggle: NFL scores and betting data](https://www.kaggle.com/datasets/tobycrabtree/nfl-scores-and-betting-data), contained an array of variables nested in a series of individual csv and xml files. This project's sole focus centered around point spread. Therefore, only csv files with the title suffix "lines.csv" from the dataset were extracted for use.

After importing the data using the read_csv() function, the immediate efforts were centered on tidying the data using a number of functions - janitor::clean_names() to generate compatible variable names, mutate() to add columns, select() to focus on the variables of interest, and rename() to rename variables.

A Bayesian regression model using the [stan_glm()](https://mc-stan.org/rstanarm/reference/stan_glm.html) function was generated, where the dependent variable is margin of victory and the independent variable is point spread (absolute).

The plots generated from the Bayesian linear model highlight an increasing probable mean margin of victory as the point spread increases. This makes sense, since those matchups are often the case of a far superior opponent versus an inferior opponent. On average, when the spread is greater than 7 points, the mean margin of victory is close to 16 points. Overall, most games are decided by double digits.

```{r}
library(tidyverse)
library(rstanarm)
```

```{r}
# Data files
list_of_files <- list.files(path = "data",
                            recursive = TRUE,
                            pattern = "\\.csv$",
                            full.names = TRUE)  
```

```{r}
# Import data
x <- read_csv(list_of_files, id = "file_name", show_col_types = FALSE) |> 
  janitor::clean_names() |> 
  drop_na() |>
  mutate(date = as.Date(date, "%m/%d/%Y"),
         spread = abs(line)) |> 
  mutate(victory_margin = abs(home_score - visitor_score)) |> 
  select(date, home_team, visitor, home_score, visitor_score, line, spread, victory_margin) |> 
  rename(home = home_team)
```

```{r}
# summary(x)
```

```{r}
# Model
obj_fit <- stan_glm(data = x,
         formula = victory_margin ~ spread,
         family = gaussian,
         refresh = 0,
         seed = 9)
```

What is the expected mean margin of victory?

```{r}
# when the spread is Greater than 7 points
obs_7.5 <- tibble(spread = seq(7.5,26.5, 0.5))
```

```{r}
pp_7.5 <- posterior_epred(object = obj_fit, newdata = obs_7.5 ) |> 
  as_tibble() |> 
  rowwise() |> 
  mutate(avg_diff_point_7.5 = mean(c_across(`1`:`39`)))
```

```{r}
plot4 <- pp_7.5 |> 
  ggplot(aes(x = avg_diff_point_7.5)) +
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   bins = 100) +
    labs(title = "Posterior for Expected mean NFL Margin of Victory when Point Spread \nis Greater than 7 Points",
         subtitle = "",
         x = "Margin of Victory (points)",
         y = "Probability",
         caption = "Source: Kaggle (NFL scores and betting data)") +
    scale_x_continuous(labels = scales::number_format()) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    theme_classic()
```

```{r}
plot4
```
